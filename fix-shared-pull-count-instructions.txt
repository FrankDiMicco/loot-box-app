====================================================================
FIX SHARED BOX PULL COUNT ON CARDS - CLAUDE CODE INSTRUCTIONS
====================================================================

CONTEXT:
- The BoxCard component shows "Pulls: X / Y" for each box
- For local boxes this updates correctly because pullHistory is
  saved to localStorage after each pull
- For shared boxes, the local reference (isSharedRef: true) has
  pullHistory: [] that never gets updated because pulls go to
  Firestore, not localStorage
- We need to fetch the real pull count from Firestore when
  displaying shared box cards on the home screen

====================================================================
CHANGES NEEDED IN index.html
====================================================================

--------------------------------------------------------------------
CHANGE 1: FETCH FRESH DATA FOR SHARED BOXES WHEN LOADING HOME
--------------------------------------------------------------------

In the App component, find the loadData function:

      const loadData = () => {
        const loadedBoxes = getAllBoxes();
        const settings = getUserSettings();
        const unreadCount = getUnreadCount();

        setBoxes(loadedBoxes);
        setUserSettings(settings);
        setNotificationCount(unreadCount);
      };

Replace it with:

      const loadData = async () => {
        const loadedBoxes = getAllBoxes();
        const settings = getUserSettings();
        const unreadCount = getUnreadCount();

        // Fetch fresh pull counts for shared boxes from Firestore
        const updatedBoxes = await Promise.all(
          loadedBoxes.map(async (box) => {
            if (box.type === 'shared' && box.shareCode) {
              try {
                const freshBox = await fetchSharedBox(box.shareCode);
                if (freshBox) {
                  return {
                    ...box,
                    pullHistory: freshBox.pullHistory || [],
                    items: freshBox.items || box.items,
                    name: freshBox.name || box.name,
                  };
                }
              } catch (err) {
                console.error('Error fetching shared box:', err);
              }
            }
            return box;
          })
        );

        setBoxes(updatedBoxes);
        setUserSettings(settings);
        setNotificationCount(unreadCount);
      };

--------------------------------------------------------------------
CHANGE 2: UPDATE LOCAL REFERENCE AFTER VIEWING A SHARED BOX
--------------------------------------------------------------------

In the App component, find the handleCloseOpener function:

      const handleCloseOpener = () => {
        setMode('home');
        setOpeningBox(null);
        loadData(); // Reload to show updated pull counts
      };

This already calls loadData() which will now fetch fresh data,
so no change needed here. But we should also update the local
reference when we get fresh Firestore data so subsequent loads
are faster. Update the loadData function above to also persist
the updated pull history back to localStorage:

In the loadData function, after the Promise.all block, add
this before setBoxes:

        // Persist updated shared box data back to localStorage
        updatedBoxes.forEach((box) => {
          if (box.type === 'shared' && box.shareCode) {
            saveBox(box);
          }
        });

So the final loadData looks like:

      const loadData = async () => {
        const loadedBoxes = getAllBoxes();
        const settings = getUserSettings();
        const unreadCount = getUnreadCount();

        // Fetch fresh pull counts for shared boxes from Firestore
        const updatedBoxes = await Promise.all(
          loadedBoxes.map(async (box) => {
            if (box.type === 'shared' && box.shareCode) {
              try {
                const freshBox = await fetchSharedBox(box.shareCode);
                if (freshBox) {
                  return {
                    ...box,
                    pullHistory: freshBox.pullHistory || [],
                    items: freshBox.items || box.items,
                    name: freshBox.name || box.name,
                  };
                }
              } catch (err) {
                console.error('Error fetching shared box:', err);
              }
            }
            return box;
          })
        );

        // Persist updated shared box data back to localStorage
        updatedBoxes.forEach((box) => {
          if (box.type === 'shared' && box.shareCode) {
            saveBox(box);
          }
        });

        setBoxes(updatedBoxes);
        setUserSettings(settings);
        setNotificationCount(unreadCount);
      };

====================================================================
THAT'S IT - ONLY loadData NEEDS TO CHANGE
====================================================================

The fix makes loadData async and fetches fresh Firestore data
for any shared boxes before displaying them. It also saves the
updated data back to localStorage so the cards show correct
counts even before the async fetch completes on next load.

FILES CHANGED: Only index.html
