====================================================================
SHARED BOX VISITOR PERSISTENCE - CLAUDE CODE INSTRUCTIONS
====================================================================

CONTEXT:
- When someone opens a shared box via link, they can pull from it
- But when they click back, the box isn't in their feed
- We want visitors to keep a read-only reference in their localStorage
- They can see the box in their feed, open it, pull, check history
- They CANNOT edit or delete it (only the creator can)

====================================================================
CHANGES NEEDED IN index.html
====================================================================

--------------------------------------------------------------------
STEP 1: SAVE VISITOR REFERENCE WHEN OPENING A SHARED LINK
--------------------------------------------------------------------

In the App component, find the loadSharedBox function. After
successfully fetching the box from Firestore, save a local
reference if the visitor doesn't already have it:

const loadSharedBox = async (shareCode) => {
  const box = await fetchSharedBox(shareCode);
  if (box) {
    // Save a read-only reference so visitor sees it in their feed
    const existingBoxes = getAllBoxes();
    const alreadySaved = existingBoxes.some(
      b => b.shareCode === shareCode
    );

    if (!alreadySaved) {
      const visitorRef = {
        id: box.id,
        name: box.name,
        type: 'shared',
        shareCode: box.shareCode,
        isSharedRef: true,
        isVisitor: true,  // THIS IS THE KEY FLAG
        items: box.items,
        maxPulls: box.maxPulls,
        pullHistory: [],  // will be fetched from Firestore
        createdAt: box.createdAt,
        boxImageId: box.boxImageId,
        hideContents: box.hideContents,
        hideOdds: box.hideOdds,
      };
      saveBox(visitorRef);
      loadData();  // refresh the box list
    }

    setOpeningBox(box);
    setMode('open');
  } else {
    error('This box no longer exists or the link is invalid');
  }
};

--------------------------------------------------------------------
STEP 2: HIDE EDIT AND DELETE BUTTONS FOR VISITORS
--------------------------------------------------------------------

In the BoxCard component, only show the edit and delete buttons
if the box is NOT a visitor reference. Find the action buttons
div (the one with the edit and delete buttons) and wrap it:

{!box.isVisitor && (
  <div style={{
    position: 'absolute',
    top: '-0.5rem',
    right: '-0.5rem',
    display: 'flex',
    gap: '0.5rem',
    zIndex: 10,
  }}>
    {/* existing edit button */}
    {/* existing delete button */}
  </div>
)}

This hides both edit and delete for visitor boxes.

--------------------------------------------------------------------
STEP 3: ADD A VISUAL INDICATOR FOR VISITOR BOXES
--------------------------------------------------------------------

In the BoxCard component, near the existing type badge at the
bottom (where it shows "Shared" or "Local"), add a "Joined"
badge for visitor boxes:

{box.isVisitor && (
  <span style={{
    padding: '0.25rem 0.75rem',
    fontSize: '0.75rem',
    fontWeight: 600,
    color: '#ffffff',
    background: 'linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%)',
    borderRadius: '6px',
    textTransform: 'uppercase',
  }}>
    Joined
  </span>
)}

So visitor boxes show both "Shared" and "Joined" badges.

--------------------------------------------------------------------
STEP 4: PREVENT EDITING VISITOR BOXES FROM APP LEVEL
--------------------------------------------------------------------

In the App component, update handleEditBox to block editing
visitor boxes as a safety net:

const handleEditBox = (box) => {
  if (box.isVisitor) {
    info('You can only view shared boxes you joined');
    return;
  }
  setEditingBox(box);
  setMode('edit');
};

--------------------------------------------------------------------
STEP 5: CLEAN UP DELETED SHARED BOXES FROM VISITOR FEEDS
--------------------------------------------------------------------

When a visitor opens a shared box from their feed (not from a
link), the handleOpenBox function fetches from Firestore. If
the box no longer exists, clean up the local reference:

Update handleOpenBox in the App component:

const handleOpenBox = async (box) => {
  if (box.type === 'shared' && box.shareCode) {
    const freshBox = await fetchSharedBox(box.shareCode);
    if (freshBox) {
      setOpeningBox(freshBox);
      setMode('open');
    } else {
      // Box was deleted - clean up local reference
      deleteBox(box.id);
      loadData();
      error('This box no longer exists. It has been removed from your list.');
      return;
    }
  } else {
    setOpeningBox(box);
    setMode('open');
  }
};

This way if the creator deletes the box, the next time a visitor
tries to open it from their feed, it gets cleaned up automatically
with a friendly message.

====================================================================
TESTING CHECKLIST
====================================================================

1. Create a shared box in browser A (creator)
2. Share the link to browser B (visitor)
3. Open the link in browser B - box should load and work
4. Click back in browser B - box should now appear in their feed
5. Verify the box card shows "Shared" and "Joined" badges
6. Verify NO edit or delete buttons on the visitor's box card
7. Click the box in browser B's feed - should open from Firestore
8. Pull from it - should work and sync to browser A
9. In browser A, delete the shared box
10. In browser B, click the box - should show "no longer exists"
    and remove it from their feed automatically

====================================================================
FILES CHANGED
====================================================================

Only index.html:
- Updated loadSharedBox to save visitor reference
- Updated BoxCard to hide edit/delete for visitor boxes
- Added "Joined" badge for visitor boxes
- Updated handleEditBox to block visitor editing
- Updated handleOpenBox to clean up deleted boxes
